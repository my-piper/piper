<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue Image Mover</title>
  </head>
  <body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        overflow: hidden;
        user-select: none;
      }
      .canvas-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: #f0f0f0;
        overflow: hidden;
      }
      .canvas-background {
        position: absolute;
        top: 0;
        left: 0;
        background-color: white;
        background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
          linear-gradient(-45deg, #ccc 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #ccc 75%),
          linear-gradient(-45deg, transparent 75%, #ccc 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }

      .layer {
        z-index: 2;
        border: 2px solid transparent;
      }

      .layer:hover {
        border-color: #007bff;
      }

      .position {
        position: absolute;
        top: -6px;
        right: -6px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 4px;
        font-size: 10px;
        border-radius: 0 0 0 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .position.dragging {
        opacity: 1;
      }
      .resize-handle {
        position: absolute;
        bottom: -6px;
        right: -6px;
        width: 12px;
        height: 12px;
        background: #007bff;
        cursor: se-resize;
        border-radius: 2px;
        opacity: 0.8;
      }

      .resize-handle:hover {
        opacity: 1;
        transform: scale(1.1);
        background: #0056b3;
      }
      .sidebar {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 200px;
      }

      .sidebar h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
      }

      .sidebar label {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 14px;
      }

      .sidebar input[type="range"] {
        width: 100%;
      }

      .sidebar span {
        font-size: 12px;
        color: #666;
      }
      .sidebar input[type="color"] {
        width: 100%;
        height: 40px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .vertical-guide {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #007bff;
        cursor: ew-resize;
        z-index: 10;
      }

      .vertical-guide:hover {
        background: #0056b3;
        width: 3px;
      }

      .vertical-guide::after {
        content: attr(data-width) "px";
        position: absolute;
        top: 10px;
        left: 5px;
        background: rgba(0, 123, 255, 0.9);
        color: white;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 3px;
        white-space: nowrap;
      }

      .horizontal-guide {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #007bff;
        cursor: ns-resize;
        z-index: 10;
      }

      .horizontal-guide:hover {
        background: #0056b3;
        height: 3px;
      }

      .horizontal-guide::after {
        content: attr(data-height) "px";
        position: absolute;
        top: 5px;
        left: 10px;
        background: rgba(0, 123, 255, 0.9);
        color: white;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 3px;
        white-space: nowrap;
      }
    </style>
    <div id="app">
      <div class="canvas-container" ref="canvas">
        <div
          class="canvas-background"
          :style="{ 
            width: canvasWidth + 'px', 
            height: canvasHeight + 'px' 
          }"
        ></div>
        <div
          class="vertical-guide"
          :style="{ left: canvasWidth + 'px' }"
          :data-width="canvasWidth"
          @mousedown="startGuideResize"
        ></div>
        <div
          class="horizontal-guide"
          :style="{ top: canvasHeight + 'px' }"
          :data-height="canvasHeight"
          @mousedown="startHorizontalGuideResize"
        ></div>
        <div
          v-for="(layer, index) in layers"
          :key="index"
          :style="{ 
            position: 'absolute',
            left: layer.x + 'px', 
            top: layer.y + 'px',
            ...(layer.type === 'image' ? {
                width: layer.width + 'px',
                height: layer.height + 'px'
            } : {})
          }"
          class="layer"
          @mousedown="startDrag($event, index)"
        >
          <img
            v-if="layer.type === 'image'"
            :src="layer.url"
            :style="{ 
              width: '100%',
              height: '100%'
            }"
            draggable="false"
          />
          <div
            v-if="layer.type === 'text'"
            :style="{ 
              fontSize: layer.fontSize + 'px',
              color: layer.color,
              fontFamily: layer.fontFamily,
              fontWeight: layer.fontWeight,
              backgroundColor: layer.backgroundColor,
              whiteSpace: 'nowrap'
            }"
          >
            {{ layer.text }}
          </div>
          <div
            v-if="layer.type === 'image'"
            class="resize-handle"
            @mousedown.stop="startResize($event, index)"
          ></div>
          <div
            v-if="DEBUG"
            class="position"
            :class="{ dragging: isDragging && index === layers.length - 1 }"
          >
            {{ layer.x }}, {{ layer.y }}
            <span v-if="layer.type === 'image'">
              | {{ layer.width }} x {{ layer.height }}</span
            >
          </div>
        </div>
      </div>
      <div
        v-if="selectedLayer && selectedLayer.type === 'text'"
        class="sidebar"
      >
        <h3>Text Properties</h3>
        <label>
          Font Size:
          <input
            type="range"
            v-model="selectedLayer.fontSize"
            min="12"
            max="72"
            step="1"
          />
          <span>{{ selectedLayer.fontSize }}px</span>
        </label>
        <label>
          Font Family:
          <select v-model="selectedLayer.fontFamily">
            <option value="Arial, sans-serif">Arial</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="'Times New Roman', serif">Times New Roman</option>
            <option value="'Courier New', monospace">Courier New</option>
            <option value="Helvetica, sans-serif">Helvetica</option>
            <option value="Verdana, sans-serif">Verdana</option>
            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
            <option value="Impact, sans-serif">Impact</option>
          </select>
        </label>
        <label>
          Font Weight:
          <select v-model="selectedLayer.fontWeight">
            <option value="normal">Normal</option>
            <option value="bold">Bold</option>
          </select>
        </label>
        <label>
          Text Color:
          <input type="color" v-model="selectedLayer.color" />
        </label>
        <label>
          Background Color:
          <div class="color-input-group">
            <input type="color" v-model="selectedLayer.backgroundColor" />
            <button @click="selectedLayer.backgroundColor = 'transparent'">
              Reset
            </button>
          </div>
        </label>
      </div>
    </div>

    <script type="module">
      const { createApp, ref, reactive, watch } = Vue;

      createApp({
        setup() {
          const DEBUG = true;
          const canvas = ref(null);
          const isDragging = ref(false);
          const isResizing = ref(false);
          const dragIndex = ref(-1);
          const resizeIndex = ref(-1);
          const dragOffset = reactive({ x: 0, y: 0 });
          const resizeStart = reactive({ x: 0, y: 0, width: 0, height: 0 });
          const selectedLayer = ref(null);
          // Load canvas dimensions from localStorage or use defaults
          const savedCanvasWidth = localStorage.getItem("compose-canvas-width");
          const savedCanvasHeight = localStorage.getItem(
            "compose-canvas-height"
          );
          const canvasWidth = ref(
            savedCanvasWidth ? parseInt(savedCanvasWidth) : 800
          );
          const canvasHeight = ref(
            savedCanvasHeight ? parseInt(savedCanvasHeight) : 600
          );

          // Save canvas dimensions to localStorage
          const saveCanvasDimensions = () => {
            localStorage.setItem(
              "compose-canvas-width",
              canvasWidth.value.toString()
            );
            localStorage.setItem(
              "compose-canvas-height",
              canvasHeight.value.toString()
            );
          };

          // Watch for canvas dimension changes and save
          watch(canvasWidth, saveCanvasDimensions);
          watch(canvasHeight, saveCanvasDimensions);

          const startGuideResize = (event) => {
            const onMouseMove = (e) => {
              const rect = canvas.value.getBoundingClientRect();
              const newWidth = Math.max(
                200,
                Math.min(e.clientX - rect.left, window.innerWidth - 50)
              );
              canvasWidth.value = newWidth;
            };

            const onMouseUp = () => {
              document.removeEventListener("mousemove", onMouseMove);
              document.removeEventListener("mouseup", onMouseUp);
            };

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
          };

          const startHorizontalGuideResize = (event) => {
            const onMouseMove = (e) => {
              const rect = canvas.value.getBoundingClientRect();
              const newHeight = Math.max(
                200,
                Math.min(e.clientY - rect.top, window.innerHeight - 50)
              );
              canvasHeight.value = newHeight;
            };

            const onMouseUp = () => {
              document.removeEventListener("mousemove", onMouseMove);
              document.removeEventListener("mouseup", onMouseUp);
            };

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
          };

          // Load from localStorage or initialize with default layers
          const savedLayers = localStorage.getItem("compose-layers");
          const layers = reactive(
            savedLayers
              ? JSON.parse(savedLayers)
              : [
                  {
                    type: "image",
                    url: "https://picsum.photos/150/100",
                    x: 50,
                    y: 50,
                    width: 150,
                    height: 100,
                  },
                  {
                    type: "image",
                    url: "https://picsum.photos/120/120",
                    x: 300,
                    y: 200,
                    width: 120,
                    height: 120,
                  },
                  {
                    type: "text",
                    text: "Hello World",
                    x: 100,
                    y: 350,
                    fontSize: 24,
                    color: "#000000",
                    fontFamily: "Arial, sans-serif",
                    fontWeight: "normal",
                    backgroundColor: "transparent",
                  },
                ]
          );

          // Save to localStorage whenever layers change
          const saveLayers = () => {
            localStorage.setItem("compose-layers", JSON.stringify(layers));
          };

          // Watch for changes and save
          watch(layers, saveLayers, { deep: true });

          const startDrag = (event, index) => {
            isDragging.value = true;
            dragIndex.value = index;

            const layer = layers.splice(index, 1)[0];
            layers.push(layer);
            dragIndex.value = layers.length - 1;
            selectedLayer.value = layer;

            const rect = canvas.value.getBoundingClientRect();
            dragOffset.x = event.clientX - rect.left - layer.x;
            dragOffset.y = event.clientY - rect.top - layer.y;

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", stopDrag);
          };

          const startResize = (event, index) => {
            isResizing.value = true;
            resizeIndex.value = index;

            const selectedLayer = layers.splice(index, 1)[0];
            layers.push(selectedLayer);
            resizeIndex.value = layers.length - 1;

            const rect = canvas.value.getBoundingClientRect();
            resizeStart.x = event.clientX - rect.left;
            resizeStart.y = event.clientY - rect.top;
            resizeStart.width = selectedLayer.width;
            resizeStart.height = selectedLayer.height;

            document.addEventListener("mousemove", onResizeMove);
            document.addEventListener("mouseup", stopResize);
          };

          const onMouseMove = (event) => {
            if (isDragging.value) {
              const rect = canvas.value.getBoundingClientRect();
              const newX = Math.floor(event.clientX - rect.left - dragOffset.x);
              const newY = Math.floor(event.clientY - rect.top - dragOffset.y);

              const layer = layers[dragIndex.value];

              if (layer.type === "image") {
                layer.x = Math.max(
                  0,
                  Math.min(newX, window.innerWidth - layer.width)
                );
                layer.y = Math.max(
                  0,
                  Math.min(newY, window.innerHeight - layer.height)
                );
              } else if (layer.type === "text") {
                layer.x = Math.max(0, Math.min(newX, window.innerWidth - 100));
                layer.y = Math.max(0, Math.min(newY, window.innerHeight - 30));
              }
            }
          };

          const onResizeMove = (event) => {
            if (!isResizing.value) return;

            const rect = canvas.value.getBoundingClientRect();
            const currentX = event.clientX - rect.left;
            const currentY = event.clientY - rect.top;

            const layer = layers[resizeIndex.value];

            if (layer.type === "image") {
              const aspectRatio = resizeStart.width / resizeStart.height;

              const deltaX = currentX - resizeStart.x;
              const deltaY = currentY - resizeStart.y;
              const delta = Math.max(deltaX, deltaY);

              const newWidth = Math.max(
                50,
                Math.floor(resizeStart.width + delta)
              );
              const newHeight = Math.max(
                50,
                Math.floor(newWidth / aspectRatio)
              );

              layer.width = Math.min(newWidth, window.innerWidth - layer.x);
              layer.height = Math.min(newHeight, window.innerHeight - layer.y);
            } else if (layer.type === "text") {
              const deltaX = currentX - resizeStart.x;
              const deltaY = currentY - resizeStart.y;

              const newWidth = Math.max(
                100,
                Math.floor(resizeStart.width + deltaX)
              );
              const newHeight = Math.max(
                30,
                Math.floor(resizeStart.height + deltaY)
              );

              layer.width = Math.min(newWidth, window.innerWidth - layer.x);
              layer.height = Math.min(newHeight, window.innerHeight - layer.y);
            }
          };

          const stopDrag = () => {
            isDragging.value = false;
            dragIndex.value = -1;
            document.removeEventListener("mousemove", onMouseMove);
            document.removeEventListener("mouseup", stopDrag);
          };

          const stopResize = () => {
            isResizing.value = false;
            resizeIndex.value = -1;
            document.removeEventListener("mousemove", onResizeMove);
            document.removeEventListener("mouseup", stopResize);
          };

          const selectLayer = (index) => {
            selectedLayer.value = layers[index];
          };

          return {
            DEBUG,
            canvas,
            layers,
            selectedLayer,
            isDragging,
            dragIndex,
            canvasWidth,
            canvasHeight,
            startDrag,
            startResize,
            startGuideResize,
            startHorizontalGuideResize,
            selectLayer,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
