---
volumes:
  mongo-data:
  redis-data:
  kafka-data:
  clickhouse-data:
  clickhouse-logs:

services:
  mongo:
    image: mongo:8.0
    ports:
      - "127.0.0.1:27017:27017"
    volumes:
      - mongo-data:/data/db

  redis:
    image: redis/redis-stack:7.2.0-v12
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data

  deno:
    image: ghcr.io/my-piper/piper-deno:sha-fcfb6e9
    ports:
      - "0.0.0.0:9090:80"
    environment:
      # Per-worker memory limit in MB (default: 128)
      # Adjust based on your workload: 64M for light, 256M for heavy
      - PER_WORKER_MEMORY_MB=128
    deploy:
      resources:
        limits:
          memory: 2G # Increased for concurrent workers
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "1.0"

  nginx:
    image: nginx:1.25.2
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../tmp/storage:/var/www/storage:ro
    ports:
      - "80:80"
    healthcheck:
      test: service nginx status || exit 1
      interval: 2s
      retries: 10
      start_period: 5s
      timeout: 5s

  clickhouse:
    image: clickhouse/clickhouse-server:24.8.4
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DB: piper
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/val/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  kafka:
    image: confluentinc/cp-kafka:7.7.1
    ports:
      - 9094:9094
    volumes:
      - kafka-data:/var/lib/kafka/data
    environment:
      - ALLOW_PLAINTEXT_LISTENER=yes
      - CLUSTER_ID=45vUBEgyQjSywv_811biQw
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_BROKER_ID=1
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT
      - KAFKA_ADVERTISED_LISTENERS=EXTERNAL://localhost:9094,INTERNAL://kafka:9092
      - KAFKA_LISTENERS=CONTROLLER://kafka:9093,EXTERNAL://0.0.0.0:9094,INTERNAL://kafka:9092
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1

  imgproxy:
    image: darthsim/imgproxy:v3.18.2
    environment:
      - IMGPROXY_LOCAL_FILESYSTEM_ROOT=/data
    volumes:
      - ./storage:/data/storage:ro
